<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>7TV Live Emote Tracker</title>
  <style>
    /* (Keep your CSS here, unchanged for brevity) */
  </style>
</head>
<body>
  <h1>ğŸ’« 7TV Live Tracker</h1>

  <div>
    <input id="channelInput" placeholder="Enter Twitch channel..." />
    <button onclick="connectStreamElements()">Track Channel</button>
  </div>
  <div id="title"></div>

  <div id="tables">
    <div class="table-container">
      <h2>ğŸ§ User Leaderboard</h2>
      <table>
        <thead><tr><th>#</th><th>User</th><th>Count</th></tr></thead>
        <tbody id="userboard"></tbody>
      </table>
    </div>

    <div class="table-container">
      <h2>ğŸ­ Emote Leaderboard</h2>
      <table>
        <thead><tr><th>#</th><th>Emote</th><th>Count</th></tr></thead>
        <tbody id="emoteboard"></tbody>
      </table>
    </div>
  </div>

  <script>
    let seSocket = null;
    let userUsage = {};
    let emoteUsage = {};
    let channel = null;

    function connectStreamElements() {
      channel = document.getElementById("channelInput").value.trim().toLowerCase();
      if (!channel) return alert("Enter a Twitch channel name");

      document.getElementById("title").innerText = `Tracking: ${channel}`;
      userUsage = {};
      emoteUsage = {};

      if (seSocket) seSocket.close();

      seSocket = new WebSocket("wss://realtime.streamelements.com/socket");

      seSocket.onopen = () => {
        console.log("âœ… Connected to StreamElements API");
      };

      seSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "welcome") {
          console.log("ğŸ‘‹ Welcome:", data.payload.sessionId);

          // Authenticate using public channel (no token needed for chat)
          seSocket.send(
            JSON.stringify({
              type: "authenticate",
              payload: {
                method: "jwt",
                token: null
              }
            })
          );

          // Subscribe to chat for the specified channel
          // Youâ€™ll need the channelâ€™s StreamElements channel ID
          fetch(`https://api.streamelements.com/kappa/v2/channels/${channel}`)
            .then((r) => r.json())
            .then((ch) => {
              console.log("ğŸ¯ Subscribing to channel:", ch._id, ch.username);
              seSocket.send(
                JSON.stringify({
                  type: "listen",
                  event: `message:${ch._id}`,
                })
              );
            })
            .catch((err) => {
              console.error("âŒ Failed to get channel:", err);
            });
        }

        if (data.type === "ping") {
          seSocket.send(JSON.stringify({ type: "pong" }));
        }

        if (data.type === "event" && data.event?.type === "message") {
          const msg = data.event.data;
          const username = msg.nick || "Unknown";
          const emotes = msg.emotes || [];

          userUsage[username] = (userUsage[username] || 0) + 1;

          emotes.forEach((e) => {
            const name = e.text || e.name || "unknown";
            emoteUsage[name] = (emoteUsage[name] || 0) + 1;
          });

          render();
        }
      };

      seSocket.onerror = (err) => console.error("WebSocket error:", err);
      seSocket.onclose = () => console.log("âš ï¸ Disconnected from StreamElements");
    }

    function render() {
      const sortedUsers = Object.entries(userUsage)
        .sort((a, b) => b[1] - a[1])
        .map(([username, count], i) => `<tr><td>${i + 1}</td><td>${username}</td><td>${count}</td></tr>`)
        .join("");

      const sortedEmotes = Object.entries(emoteUsage)
        .sort((a, b) => b[1] - a[1])
        .map(([emote, count], i) => `<tr><td>${i + 1}</td><td>${emote}</td><td>${count}</td></tr>`)
        .join("");

      document.getElementById("userboard").innerHTML = sortedUsers;
      document.getElementById("emoteboard").innerHTML = sortedEmotes;
    }
  </script>
</body>
</html>
